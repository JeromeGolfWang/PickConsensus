<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Week Consensus</title>
</head>
<body>
    <h1>Week Consensus and Leaderboard</h1>
    <div id="consensusResults"></div>
    <div id="leaderboard"></div>

    <script>
        // Replace '1' with the current week number as needed
        const weekNumber = 1; 

        // Mapping old player names to the new names
        const playerNameMap = {
            'Player1': 'Dan',
            'Player2': 'Tim',
            'Player3': 'Patrick',
            'Player4': 'Jay'
        };

        async function fetchPicksForWeek(week) {
            const response = await fetch(`https://solitary-boat-e4cc.jay-finnigan.workers.dev/fetch-picks?week=${week}`);
            if (!response.ok) {
                console.error('Failed to fetch picks data:', response.statusText);
                return [];
            }
            return await response.json();
        }

        function calculateConsensusAndLeaderboard(savedPicks) {
            const consensus = {};
            const playerScores = {};

            savedPicks.forEach(pick => {
                pick.games.forEach(game => {
                    if (!consensus[game.loser]) {
                        consensus[game.loser] = 0;
                    }
                    consensus[game.loser] += parseInt(game.confidence);

                    const playerName = playerNameMap[pick.player] || pick.player;

                    if (!playerScores[playerName]) {
                        playerScores[playerName] = 0;
                    }
                    playerScores[playerName] += parseInt(game.confidence);
                });
            });

            // Find consensus losers
            const consensusEntries = Object.entries(consensus).sort((a, b) => b[1] - a[1]);
            const consensusResultsDiv = document.getElementById('consensusResults');
            consensusResultsDiv.innerHTML = `<h2>Consensus Losers</h2><ul>${consensusEntries.map(entry => `<li>${entry[0]}: ${entry[1]}</li>`).join('')}</ul>`;

            // Find top 4 players by score
            const leaderboardEntries = Object.entries(playerScores).sort((a, b) => b[1] - a[1]);
            const leaderboardDiv = document.getElementById('leaderboard');
            leaderboardDiv.innerHTML = `<h2>Top 4 Players</h2><ul>${leaderboardEntries.slice(0, 4).map(entry => `<li>${entry[0]}: ${entry[1]}</li>`).join('')}</ul>`;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const savedPicks = await fetchPicksForWeek(weekNumber);
            calculateConsensusAndLeaderboard(savedPicks);
        });
    </script>
</body>
</html>
