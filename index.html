<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (keep existing head content) ... -->
</head>
<body>
    <!-- Week Selection -->
    <select id="weekSelector">
        <option value="">Select Week</option>
        <!-- Options will be populated dynamically -->
    </select>

    <!-- Player Selection -->
    <select id="playerSelector">
        <option value="">Select Player</option>
        <option value="Dan">Dan</option>
        <option value="Tim">Tim</option>
        <option value="Patrick">Patrick</option>
        <option value="Jay">Jay</option>
    </select>

    <!-- Form for Picks -->
    <form id="picksForm"></form>

    <!-- Button to Save Picks -->
    <button id="savePicksButton">Save Picks</button>

    <!-- Button to View Week Consensus -->
    <button id="consensusButton" style="display:none;">View Week Consensus</button>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let games = [];
            let headers = [];
            const sheetUrl = './NFL Schedule - Sheet1.csv';
            const apiUrl = 'https://soft-lab-bfdb.jay-finnigan.workers.dev';

            function fetchSchedule() {
                console.log("Fetching CSV schedule...");
                fetch(sheetUrl)
                    .then(response => response.text())
                    .then(data => {
                        console.log("CSV data received");
                        const rows = data.trim().split('\n').map(row => row.split(','));
                        headers = rows[0];
                        games = rows.slice(1);
                        
                        const allWeeks = [...new Set(games.map(game => game[headers.indexOf("Week")]))];
                        populateWeekSelector(allWeeks);
                        
                        // Set initial week
                        const initialWeek = allWeeks[0];
                        document.getElementById('weekSelector').value = initialWeek;
                        populateGamesForWeek(initialWeek);
                    })
                    .catch(error => console.error("Failed to fetch or process CSV data:", error));
            }

            function populateWeekSelector(weeks) {
                const weekSelector = document.getElementById("weekSelector");
                weeks.forEach(week => {
                    const option = document.createElement("option");
                    option.value = week;
                    option.textContent = `Week ${week}`;
                    weekSelector.appendChild(option);
                });

                weekSelector.addEventListener("change", function() {
                    const selectedWeek = this.value;
                    populateGamesForWeek(selectedWeek);
                });
            }

            function populateGamesForWeek(selectedWeek) {
                const form = document.getElementById("picksForm");
                form.innerHTML = '';

                const weekGames = games.filter(game => game[headers.indexOf("Week")] === selectedWeek);
                weekGames.forEach((game, index) => {
                    const visTm = game[headers.indexOf("VisTm")];
                    const homeTm = game[headers.indexOf("HomeTm")];
                    const day = game[headers.indexOf("Day")];
                    const date = game[headers.indexOf("Date")];
                    const time = game[headers.indexOf("Time")];

                    const div = document.createElement("div");
                    div.innerHTML = `
                        <label>Week ${selectedWeek}: ${visTm} @ ${homeTm} (${day}, ${date} at ${time})</label>
                        <select name="game${index}">
                            <option value="">Select Loser</option>
                            <option value="${homeTm}">${homeTm}</option>
                            <option value="${visTm}">${visTm}</option>
                        </select>
                        <select name="confidence${index}">
                            ${Array.from({length: weekGames.length}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('')}
                        </select>
                    `;
                    form.appendChild(div);
                });

                updateConfidenceOptions();
            }

            function updateConfidenceOptions() {
                // ... (keep existing updateConfidenceOptions function) ...
            }

            async function savePicks() {
                const selectedPlayer = document.getElementById('playerSelector').value;
                const selectedWeek = document.getElementById("weekSelector").value;

                if (!selectedPlayer || !selectedWeek) {
                    alert("Please select both a player and a week before saving.");
                    return;
                }

                const games = [];
                document.querySelectorAll('select[name^="game"]').forEach((select, index) => {
                    const confidenceSelect = document.querySelector(`select[name="confidence${index}"]`);
                    if (select.value && confidenceSelect.value) {
                        games.push(`${index}:${select.value}:${confidenceSelect.value}`);
                    }
                });

                const dataToSend = games.join('|');
                console.log(`Sending data for player ${selectedPlayer}, week ${selectedWeek}:`, dataToSend);

                try {
                    const response = await fetch(`${apiUrl}/save-picks?player=${selectedPlayer}&week=${selectedWeek}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain'
                        },
                        body: dataToSend
                    });

                    if (response.ok) {
                        alert('Your picks have been saved successfully!');
                        document.getElementById('consensusButton').style.display = 'block';
                    } else {
                        const errorText = await response.text();
                        alert(`Error saving picks: ${errorText}`);
                    }
                } catch (error) {
                    console.error('Error in fetch operation:', error);
                    alert('An error occurred while saving your picks. Please try again.');
                }
            }

            document.getElementById('savePicksButton').addEventListener('click', savePicks);
            document.getElementById('consensusButton').addEventListener('click', function() {
                window.location.href = '/consensus.html';
            });

            fetchSchedule();
        });
    </script>
</body>
</html>